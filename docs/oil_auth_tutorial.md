# Oil Authentication Tutorial

This tutorial walks through the end-to-end oil authentication workflow using **foodspec**.

## 1. Load data
```python
from foodspec.data.loader import load_example_oils

spectra = load_example_oils()
print(spectra.x.shape, spectra.metadata.head())
```

## 2. Inspect raw spectra
```python
from foodspec.viz.spectra import plot_spectra, plot_mean_spectrum
import matplotlib.pyplot as plt

plot_spectra(spectra, color_by="oil_type")
plt.show()
```

## 3. Run the authentication workflow
```python
from foodspec.apps.oils import run_oil_authentication_workflow

result = run_oil_authentication_workflow(spectra, label_column="oil_type", classifier_name="rf", cv_splits=5)
print(result.cv_metrics)
print("Confusion matrix:\n", result.confusion_matrix)

# Inspect feature importances (if available, e.g., RandomForest)
if result.feature_importances is not None:
    print(result.feature_importances.sort_values(ascending=False).head())
```

## 4. Visualize results
```python
from foodspec.viz.classification import plot_confusion_matrix

plot_confusion_matrix(result.confusion_matrix, class_names=result.class_labels)
plt.show()
```

## 5. Inspect features and model
- `result.pipeline` holds the fitted preprocessing + feature + classifier pipeline.
- `result.feature_importances` (if available) ranks important peaks/ratios.
- Change classifier by setting `classifier_name` (e.g., `"rf"`, `"svm_rbf"`, `"logreg"`) in the workflow or CLI options.

## 6. Next steps
- Swap classifiers via `classifier_name` (e.g., `svm_rbf`, `logreg`, `rf`).
- Integrate your own datasets using `load_folder` and consistent metadata columns.
# Oil authentication workflow

## Scientific question
“Which oil type is this? Is the sample authentic or adulterated?” The goal is to classify spectra (Raman or FTIR) into known oil types and flag potential adulteration.

### Expected input
- A spectral library (HDF5) created from CSV/TXT using `foodspec csv-to-library` or `foodspec preprocess`.
- Metadata must contain an oil-type label column (e.g., `oil_type`), and optionally batch or instrument identifiers.
- Sample preparation (outside the scope of this package): consistent dilution (if any), identical optical path/ATR pressure, and minimal fluorescence/background for Raman.

## Workflow overview (CSV → HDF5 → foodspec oil-auth)
1. Start from raw CSV/TXT (wide or long).  
2. Convert to HDF5 library:
   ```bash
   foodspec csv-to-library data/oils.csv libraries/oils.h5 --format wide --wavenumber-column wavenumber --modality raman --label-column oil_type
   ```
3. Run authentication:
   ```bash
   foodspec oil-auth libraries/oils.h5 --label-column oil_type --classifier-name rf --cv-splits 5 --output-dir runs/oil_auth
   ```
   - `--label-column`: metadata column with ground truth classes.
   - `--classifier-name`: choose `rf` (random forest), `svm_rbf`, `logreg`, etc.
   - `--cv-splits`: stratified folds (default 5).
   - Outputs: metrics.json/CSV, confusion_matrix.png, report.md in a timestamped folder.

## Preprocessing used by the workflow
- **Baseline correction (ALS)**: removes fluorescence/background (Raman) or sloping baselines (FTIR).  
- **Smoothing (Savitzky–Golay)**: reduces noise while preserving peak shape.  
- **Normalization (Vector/MSC)**: compensates for intensity scaling/scatter differences.  
- **Cropping (600–1800 cm⁻¹)**: focuses on fingerprint region where most discriminative oil bands reside.  
Rationale: improve class separability by stabilizing baseline and scale, and restricting to informative bands.

## Classification models (intuitive view)
- **Logistic regression**: linear decision boundary; good baseline model.  
- **SVM (linear/RBF)**: margin maximization; RBF can capture nonlinear boundaries.  
- **Random forest**: ensemble of decision trees; robust to nonlinearities and variable importance can be inspected.  
All models are trained on peak/ratio features generated by the workflow pipeline.

## Reported metrics and interpretation
- **Accuracy**: overall correctness; >0.9 often expected for clean lab datasets, lower for challenging/real-world data.  
- **Macro F1**: balances precision/recall across classes; robust to class imbalance.  
- **Confusion matrix**: identifies which classes are confused (e.g., similar fatty-acid profiles).  
- **Precision/Recall** (per-class, in tables): useful for adulteration detection where false negatives matter.

### Reporting guidance (paper/MethodsX)
- **Main text/figures**: confusion matrix figure; overall accuracy and macro F1; brief description of preprocessing and model.  
- **Supplementary**: per-class precision/recall/F1 table; details on hyperparameters; additional representative spectra.  
- **Follow-up analyses**: independent validation set, robustness across batches/instruments, adulteration levels, and external QC (e.g., GC–MS reference).
